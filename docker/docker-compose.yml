version: "3.7"

services:
  road2:
    build:
      context: ..
      dockerfile: ./docker/centos-wo-aws/Dockerfile
    image: road2
    container_name: road2-server
    depends_on:
      - pgrouting
    environment:
      - NODE_ENV=debug
    ports:
      - 8080:8080
      - 9229:9229
      - 443:443
    volumes:
      - iti-data-volume:/home/docker/data
      - ${road2_src}:/home/docker/app/src
      - ${road2_test}:/home/docker/app/test
      - ${road2_config}:/home/docker/config
    networks:
      - iti-network
    secrets:
      - key
      - cert

  r2gg:
    build:
      context: ../../route-graph-generator/
      dockerfile: ./docker/centos7/Dockerfile
    image: r2gg
    container_name: r2gg
    depends_on:
      - pgrouting
    volumes:
      - iti-data-volume:/home/docker/data
      - ${r2gg_src}:/usr/lib/python3.6/site-packages/r2gg/r2gg
    networks:
      - iti-network
    command: "./r2gg_pipeline.sh"
    environment:
      - R2GG_ARG=${R2GG_ARG}
      - GENERATION_TYPE=${GENERATION_TYPE}
    secrets:
      - db_config

  pgrouting:
    build:
      context: ../../pgrouting-procedures/
      dockerfile: ./docker/centos7/Dockerfile
      args:
        - ipRange=${iprange}
    image: pgrouting
    container_name: pgrouting-server
    expose:
      - 5432
    ports:
      - 5432:5432
    networks:
      - iti-network
    volumes:
      - pgr-data-volume:/var/lib/pgsql
      - ${procedures_path}:/home/docker/pgrouting-procedures/sql

  road2-web:
    build:
      context: ..
      dockerfile: ./docker/web/Dockerfile
    image: road2-web-debian
    container_name: road2-web-server
    depends_on:
      - road2
    ports:
      - 8081:80
    volumes:
      - ${road2_web_src}:/home/docker/web/www/road2
    networks:
      - iti-network

  road2-gatling:
    image: denvazh/gatling
    container_name: road2-gatling
    depends_on:
      - road2
    volumes:
      - ${gatling_user_files}:/opt/gatling/user-files
      - ${gatling_results}:/opt/gatling/results
    networks:
      - iti-network
    command: "-s ${gatling_test_name}"

volumes:
  iti-data-volume:
    name: iti-data-volume
  pgr-data-volume:
    name: pgr-data-volume

networks:
  iti-network:
    name: iti-network
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: ${iprange}

secrets:
  db_config:
    file: ${db_config_file}
  key:
    file: ${road2_key}
  cert:
    file: ${road2_cert}
